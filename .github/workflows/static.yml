name: Deploy quant reports to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["master"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Pages content
        run: |
          set -e
          rm -rf public
          mkdir -p public/reports public/strategies public/trades

          if [ -f reports/latest.md ]; then
            cp reports/latest.md public/latest.md
          else
            printf '%s\n' \
              '# Daily Quant Notes' \
              '' \
              '`reports/latest.md` is not found yet.' \
              '' \
              'Please add your latest statistics and analysis in `reports/latest.md`.' \
              > public/latest.md
          fi

          cp README.md public/

          if [ -f docs/STRATEGY_REQUIREMENTS.md ]; then
            cp docs/STRATEGY_REQUIREMENTS.md public/strategies/
          fi

          cp config/strategies/*.yaml public/strategies/ 2>/dev/null || true
          cp reports/strategies/*.md public/strategies/ 2>/dev/null || true

          cp reports/*.md public/reports/ 2>/dev/null || true
          cp reports/*.png public/reports/ 2>/dev/null || true

          cp reports/trades/*.csv public/trades/ 2>/dev/null || true
          cp reports/trades/*.md public/trades/ 2>/dev/null || true
          cp reports/trades/*.html public/trades/ 2>/dev/null || true

          cp data/backtest/trades/*.csv public/trades/ 2>/dev/null || true

          if [ ! -f public/trades/README.md ]; then
            printf '%s\n' \
              '# Buy/Sell Records' \
              '' \
              'Put trade CSV files under `reports/trades/` to publish them.' \
              > public/trades/README.md
          fi

          printf '%s\n' '# 策略配置与说明' > public/strategies/index.md
          ls public/strategies >/tmp/strategies_list.txt
          while IFS= read -r f; do
            [ "$f" = "index.md" ] && continue
            printf -- '- [%s](./%s)\n' "$f" "$f" >> public/strategies/index.md
          done < /tmp/strategies_list.txt

          printf '%s\n' '# 统计报告列表' > public/reports/index.md
          ls public/reports >/tmp/reports_list.txt
          while IFS= read -r f; do
            [ "$f" = "index.md" ] && continue
            printf -- '- [%s](./%s)\n' "$f" "$f" >> public/reports/index.md
          done < /tmp/reports_list.txt

          # 如果reports/trades/index.md存在则使用它，否则自动生成
          if [ -f reports/trades/index.md ]; then
            cp reports/trades/index.md public/trades/index.md
          else
            printf '%s\n' '# 买卖记录列表' > public/trades/index.md
            ls public/trades >/tmp/trades_list.txt
            while IFS= read -r f; do
              [ "$f" = "index.md" ] && continue
              printf -- '- [%s](./%s)\n' "$f" "$f" >> public/trades/index.md
            done < /tmp/trades_list.txt
          fi

          COMMIT_ID=$(git rev-parse --short HEAD)
          printf '%s\n' \
            '<!doctype html>' \
            '<html lang="zh-CN">' \
            '<head>' \
            '  <meta charset="utf-8" />' \
            '  <meta name="viewport" content="width=device-width, initial-scale=1" />' \
            '  <title>量化统计结果 v0.1</title>' \
            '  <style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;max-width:840px;margin:2rem auto;padding:0 1rem;line-height:1.6}.card{border:1px solid #e5e7eb;border-radius:10px;padding:1rem 1.2rem;margin-top:1rem}.commit-id{position:absolute;top:1rem;right:1rem;font-size:0.75rem;color:#6b7280;font-family:monospace}</style>' \
            '</head>' \
            '<body style="position:relative">' \
            "  <div class=\"commit-id\">commit: ${COMMIT_ID}</div>" \
            '  <h1>量化统计结果（v0.1）</h1>' \
            '  <div class="card"><a href="./latest.html">最新统计</a></div>' \
            '  <div class="card"><a href="./reports/index.html">统计报告列表</a></div>' \
            '  <div class="card"><a href="./trades/index.html">买卖记录列表</a></div>' \
            '  <div class="card"><a href="./strategies/index.html">策略配置与说明</a></div>' \
            '  <div class="card"><a href="./README.html">项目说明（README）</a></div>' \
            '</body>' \
            '</html>' \
            > public/index.html

          # Jekyll配置：让GitHub Pages渲染Markdown文件
          printf '%s\n' \
            'markdown: GFM' \
            'theme: jekyll-theme-minimal' \
            'title: A股量化回测' \
            'description: 人气策略回测结果' \
            > public/_config.yml

          # 给所有md文件添加front matter，否则Jekyll不会处理
          find public -name "*.md" -type f | while read mdfile; do
            if ! head -1 "$mdfile" | grep -q '^---'; then
              tmp=$(mktemp)
              printf '%s\n' '---' 'layout: default' '---' '' > "$tmp"
              cat "$mdfile" >> "$tmp"
              mv "$tmp" "$mdfile"
            fi
          done

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Install Jekyll
        run: |
          cd public
          gem install jekyll bundler
          cat > Gemfile << 'EOF'
          source "https://rubygems.org"
          gem "jekyll", "~> 4.3"
          gem "jekyll-theme-minimal"
          EOF
          bundle install

      - name: Build with Jekyll
        run: |
          cd public
          bundle exec jekyll build --destination ../_site
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
